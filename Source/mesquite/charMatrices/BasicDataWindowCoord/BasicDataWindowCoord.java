/* Mesquite source code.  Copyright 1997-2006 W. Maddison and D. Maddison.Version 1.11, June 2006.Disclaimer:  The Mesquite source code is lengthy and we are few.  There are no doubt inefficiencies and goofs in this code. The commenting leaves much to be desired. Please approach this source code with the spirit of helping out.Perhaps with your help we can be more than a few, and make Mesquite better.Mesquite is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.Mesquite's web site is http://mesquiteproject.orgThis source code and its compiled class files are free and modifiable under the terms of GNU Lesser General Public License.  (http://www.gnu.org/copyleft/lesser.html)*/package mesquite.charMatrices.BasicDataWindowCoord; /*~~  */import java.util.*;import java.awt.*;import mesquite.lib.*;import mesquite.lib.characters.*;import mesquite.lib.duties.*;/** Coordinates the display of the spreadsheet editor window for character matrices.  This doesn't actually make the window (see BasicDataWindowMaker). */public class BasicDataWindowCoord extends FileInit {	public void getEmployeeNeeds(){  //This gets called on startup to harvest information; override this and inside, call registerEmployeeNeed		EmployeeNeed e = registerEmployeeNeed(DataWindowMaker.class, "Character Matrix Editors display character matrices to the user.", 				"You may request a character matrix editor by selecting the Character Matrix item under the Characters menu");				e.setAsEntryPoint("showDataWindow " + 0);	}	MesquiteSubmenuSpec elementsSubmenu, newViewSubmenu;	/*.................................................................................................................*/	public boolean startJob(String arguments, Object condition, CommandRecord commandRec, boolean hiredByName) { 		elementsSubmenu = getFileCoordinator().addSubmenu(MesquiteTrunk.charactersMenu, "Character Matrix Editor", makeCommand("showDataWindow",  this));		elementsSubmenu.setBehaviorIfNoChoice(MesquiteSubmenuSpec.ONEMENUITEM_ZERODISABLE); 		newViewSubmenu = getFileCoordinator().addSubmenu(MesquiteTrunk.charactersMenu, "Extra Matrix Editor", makeCommand("showExtraDataWindow",  this));		newViewSubmenu.setBehaviorIfNoChoice(MesquiteSubmenuSpec.ONEMENUITEM_ZERODISABLE);		return true;  	 }	/*.................................................................................................................*/	/** A method called immediately after the file has been read in.*/	public void projectEstablished() {		elementsSubmenu.setList( getProject().datas);		newViewSubmenu.setList( getProject().datas);	} 	 String dataRef(CharacterData d, boolean internal){  	 	if (internal)  	 		return getProject().getCharMatrixReferenceInternal(d);  	 	return getProject().getCharMatrixReferenceExternal(d);  	 }	/*.................................................................................................................*/   	 public boolean isSubstantive(){   	 	return false;   	 }	/*.................................................................................................................*/  	 public boolean isPrerelease() {		return false;   	 }	/*.................................................................................................................*/	/**Returns command to hire employee if clonable*/	public String getClonableEmployeeCommand(MesquiteModule employee){		if (employee!=null && employee.getEmployer()==this) {			if (employee.getHiredAs()==DataWindowMaker.class) {				CharacterData d = (CharacterData)employee.doCommand("getDataSet", null, CommandRecord.getRecSIfNull(), CommandChecker.defaultChecker);				if (d != null) {					return ("showDataWindow " + dataRef(d, true) + "  " + StringUtil.tokenize(employee.getName()) + ";");//quote				}			}		}		return null;	}	/*.................................................................................................................*/  	 public Snapshot getSnapshot(MesquiteFile file) {   	 	Snapshot temp = new Snapshot();   	 	Vector datasShown = new Vector();		for (int i = 0; i<getNumberOfEmployees(); i++) {			Object e=getEmployeeVector().elementAt(i);			if (e instanceof DataWindowMaker) {				DataWindowMaker dwm = (DataWindowMaker)e;				CharacterData d = (CharacterData)dwm.doCommand("getDataSet", null, CommandRecord.getRecNSIfNull(), CommandChecker.defaultChecker);				if (d != null) {					if (datasShown.indexOf(d)>=0)						temp.addLine("showExtraDataWindow " + dataRef(d, false), dwm);					else {						temp.addLine("showDataWindow " + dataRef(d, false), dwm);						datasShown.addElement(d);					}				}			}		}		datasShown.removeAllElements();  	 	return temp;  	 }	/*.................................................................................................................*/	MesquiteInteger pos = new MesquiteInteger();	CharacterData findData(String arguments, MesquiteFile file, CommandRecord commandRec){	   	 	CharacterData data = null;	   	 	if (StringUtil.blank(arguments)){	   	 		int numDatas = getProject().getNumberCharMatrices();	   	 		//if only one taxa block, use it	   	 		if (numDatas<=0){	   	 			return null;	   	 		}	   	 		else if (numDatas==1){		   	 		data =  getProject().getCharacterMatrix(0);	   	 		}	   	 		else {		   	 		data =  getProject().chooseData(containerOfModule(), null, null, "Which data matrix would you like to display in an data editor window?", commandRec);	   	 			//else, query user	   	 		}	   	 	}	   	 	else { 		   	 	data =  getProject().getCharacterData(file, parser.getFirstToken(arguments));   	 		}   	 		return data;	}		DataWindowMaker findEditor(CharacterData data, CommandRecord commandRec){    	 		//next, find if already has DataWindowMaker module for it			for (int i = 0; i<getNumberOfEmployees(); i++) {				Object e=getEmployeeVector().elementAt(i);				if (e instanceof DataWindowMaker) {					DataWindowMaker dwm = (DataWindowMaker)e;					CharacterData d = dwm.getCharacterData();					if (d == data) {						if (dwm.getModuleWindow() !=null) {							dwm.getModuleWindow().setVisible(true);							dwm.getModuleWindow().toFront();						}						return dwm;					}				}			}			return null;	}	/*.................................................................................................................*/	/** Generated by an employee who quit.  The MesquiteModule should act accordingly. */ 	public void employeeQuit(MesquiteModule employee) { 		if (employee instanceof DataWindowMaker) {  // character source quit and none rehired automatically 			DataWindowMaker dwm = (DataWindowMaker)employee; 			unlinkEditors(dwm.getCharacterData(), dwm); 			 		}	}	void linkEditors(CharacterData data, DataWindowMaker newDWM){			for (int i = 0; i<getNumberOfEmployees(); i++) {				Object e=getEmployeeVector().elementAt(i);				if (e instanceof DataWindowMaker && e != newDWM) {					DataWindowMaker dwm = (DataWindowMaker)e;					CharacterData d = dwm.getCharacterData();					if (d == data) {						dwm.linkEditor(newDWM, true);						newDWM.linkEditor(dwm, false);					}				}			}	}	void unlinkEditors(CharacterData data, DataWindowMaker newDWM){			for (int i = 0; i<getNumberOfEmployees(); i++) {				Object e=getEmployeeVector().elementAt(i);				if (e instanceof DataWindowMaker && e != newDWM) {					DataWindowMaker dwm = (DataWindowMaker)e;					CharacterData d = dwm.getCharacterData();					if (d == data) {						dwm.unlinkEditor(newDWM);						newDWM.unlinkEditor(dwm);					}				}			}	}	/*.................................................................................................................*/    	 public Object doCommand(String commandName, String arguments, CommandRecord commandRec, CommandChecker checker) {    	 	if (checker.compare(this.getClass(), "Shows the data editor window.  If a data editor window for this matrix already exists, it is brought to the front", "[number of data matrix to be shown] [name of data matrix to be shown]", commandName, "showDataWindow")) {  //IF WINDOW ALREADY SHOWN, JUST BRING IT TO FRONT	   	 	//first, find the data set requested	   	 	CharacterData data = findData(arguments, checker.getFile(), commandRec);    	 		if (data == null)    	 			return null;    	 		/**/    	 		DataWindowMaker dwm = findEditor(data, commandRec);    	 		if (dwm!=null)    	 			return dwm;						//if no data window module active, hire one			DataWindowMaker mb = (DataWindowMaker)hireEmployee(commandRec, DataWindowMaker.class, null);			if (mb!=null) {				mb.setAsExtra(false);	   	 		mb.doCommand("makeWindow", getProject().getCharMatrixReferenceInternal(data), commandRec, checker);			} 			return mb;    	 	}    	 	else if (checker.compare(this.getClass(), "Shows an extra data editor window.", "[number of data matrix to be shown] [name of data matrix to be shown]", commandName, "showExtraDataWindow")) {  //IF WINDOW ALREADY SHOWN, JUST BRING IT TO FRONT	   	 	//first, find the data set requested	   	 	CharacterData data = findData(arguments, checker.getFile(), commandRec);    	 		if (data == null)    	 			return null;						//if no data window module active, hire one			DataWindowMaker mb = (DataWindowMaker)hireEmployee(commandRec, DataWindowMaker.class, null);			if (mb!=null) {				mb.setAsExtra(true);	   	 		mb.doCommand("makeWindow", getProject().getCharMatrixReferenceInternal(data), commandRec, checker);	    	 		linkEditors(data, mb);			} 			return mb;    	 	}    	 	else    	 		return super.doCommand(commandName, arguments, commandRec, checker);   	 }	/*.................................................................................................................*/    	 public String getName() {		return "Data Window Coordinator";   	 }   	 	/*.................................................................................................................*/   	  	/** returns an explanation of what the module does.*/ 	public String getExplanation() { 		return "Coordinates the creation of basic data windows." ;   	 }   	 }	